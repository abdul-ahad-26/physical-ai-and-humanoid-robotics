# API Contract: Answer Endpoint

## Endpoint
`POST /answer`

## Purpose
Accepts a user question and returns a final natural-language answer generated by the AI agent. This endpoint orchestrates the full process of content retrieval, context assembly, and AI response generation.

## Request

### Headers
- `Content-Type: application/json`

### Body Parameters
```json
{
  "question": {
    "type": "string",
    "required": true,
    "minLength": 1,
    "maxLength": 10000,
    "description": "The user's question about textbook content"
  },
  "k": {
    "type": "integer",
    "required": false,
    "minimum": 1,
    "maximum": 10,
    "default": 3,
    "description": "Number of content chunks to retrieve for context"
  },
  "highlight_override": {
    "type": "string",
    "required": false,
    "minLength": 1,
    "maxLength": 5000,
    "description": "Optional highlighted text that replaces search context"
  }
}
```

### Example Request
```json
{
  "question": "Explain the difference between supervised and unsupervised learning?",
  "k": 5,
  "highlight_override": "The textbook mentions that these are two fundamental approaches in machine learning."
}
```

## Response

### Success Response (200 OK)
```json
{
  "answer": {
    "type": "string",
    "description": "The AI-generated answer to the user's question"
  },
  "retrieved_contexts": {
    "type": "array",
    "items": {
      "content": "string",
      "metadata": "object",
      "score": "number"
    },
    "description": "Context chunks used to generate the answer"
  },
  "confidence_score": {
    "type": "number",
    "minimum": 0,
    "maximum": 1,
    "description": "Confidence score of the generated answer"
  },
  "answer_id": {
    "type": "string",
    "description": "Unique identifier for this answer operation"
  }
}
```

### Example Success Response
```json
{
  "answer": "Supervised learning uses labeled training data to learn a mapping from inputs to outputs, while unsupervised learning finds patterns in data without labeled responses. Supervised learning examples include classification and regression tasks, whereas unsupervised learning includes clustering and dimensionality reduction.",
  "retrieved_contexts": [
    {
      "content": "Supervised learning is a type of machine learning where the model is trained on labeled data...",
      "metadata": {
        "source_file": "chapter_4_supervised_learning.md",
        "section": "4.1 Definition",
        "page_number": 62
      },
      "score": 0.92
    },
    {
      "content": "Unsupervised learning algorithms work with unlabeled data to discover hidden patterns...",
      "metadata": {
        "source_file": "chapter_5_unsupervised_learning.md",
        "section": "5.1 Introduction",
        "page_number": 78
      },
      "score": 0.88
    }
  ],
  "confidence_score": 0.94,
  "answer_id": "answer_67890"
}
```

### Error Responses

#### 400 Bad Request
- **Condition**: Invalid request parameters
- **Response Body**:
```json
{
  "error": "Invalid input parameters",
  "details": "Error description"
}
```

#### 422 Unprocessable Entity
- **Condition**: Validation errors
- **Response Body**:
```json
{
  "error": "Validation failed",
  "details": {
    "question": "Question is required and cannot be empty"
  }
}
```

#### 429 Too Many Requests
- **Condition**: Rate limit exceeded
- **Response Body**:
```json
{
  "error": "Rate limit exceeded",
  "details": "Too many requests, please try again later"
}
```

#### 503 Service Unavailable
- **Condition**: AI service or Qdrant unavailable
- **Response Body**:
```json
{
  "error": "Service temporarily unavailable",
  "details": "AI service is currently down, please try again later"
}
```

## Security
- No authentication required (public endpoint)
- Rate limiting applied using hybrid approach (requests, tokens, concurrent)
- Input sanitization to prevent prompt injection

## Performance Requirements
- Response time: < 2 seconds for 95th percentile
- Should gracefully degrade when components are unavailable
- Agent should minimize unnecessary tool calls (80% efficiency target)

## Monitoring
- Log all requests for analytics
- Track answer quality metrics
- Monitor response times
- Record agent tool usage efficiency